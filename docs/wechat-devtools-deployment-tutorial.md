# 微信开发者工具云函数部署详细教程

## 📱 第一步：打开微信开发者工具

### 1.1 导入项目
1. 启动微信开发者工具
2. 点击 "导入项目" 或 "+"
3. **项目目录**：选择 `text-to-images-mp/miniprogram` 文件夹
   ```
   例如：D:\cloudcheng\work\10-AI-mp\text-to-images-mp\miniprogram
   ```
4. **AppID**：输入您的小程序AppID
5. **项目名称**：AI文字生成图片
6. 点击 "导入"

### 1.2 确认项目结构
导入后，在左侧文件树中应该看到：
```
miniprogram/
├── cloudfunctions/
│   ├── login/
│   ├── aiGenerate/
│   ├── userInfo/
│   └── workManage/
├── pages/
├── utils/
├── app.js
└── project.config.json
```

## ☁️ 第二步：开通云开发

### 2.1 首次开通
如果是第一次使用云开发：

1. 点击工具栏的 **"云开发"** 按钮（云朵图标）
2. 会弹出开通引导页面
3. 点击 **"开通云开发"**
4. 选择计费方式（建议选择按量付费）
5. 等待开通完成

### 2.2 创建云环境
1. 开通完成后，会进入云开发控制台
2. 点击 **"新建环境"**
3. **环境名称**：`ai-image-prod`
4. **环境ID**：系统自动生成（如：`cloud1-7gndy7e31d73bb76`）
5. **⚠️ 重要**：记录下环境ID，稍后需要配置

### 2.3 更新环境配置
回到微信开发者工具，打开 `app.js` 文件：
```javascript
// 找到这段代码，替换环境ID
wx.cloud.init({
  env: 'cloud1-7gndy7e31d73bb76', // 替换为您的实际环境ID
  traceUser: true,
});
```

## 🔧 第三步：部署云函数（重点操作）

### 3.1 部署 login 云函数

#### 操作步骤：
1. **找到云函数**：在左侧文件树中，展开 `cloudfunctions` 文件夹
2. **右键操作**：右键点击 `login` 文件夹
3. **选择部署选项**：在弹出的右键菜单中，找到并点击：
   ```
   "创建并部署：云端安装依赖"
   ```
4. **等待部署**：工具下方会显示部署进度
5. **确认完成**：看到 "上传成功" 提示

#### 右键菜单选项说明：
```
右键 login 文件夹后，会看到：
├── 新建文件
├── 新建文件夹  
├── 重命名
├── 删除
├── 在外部文件管理器中显示
├── 在终端中打开
├── ──────────── (分割线)
├── 创建并部署：云端安装依赖    ← 选择这个！
├── 创建并部署：不安装依赖
├── 增量上传：云端安装依赖
└── 增量上传：不安装依赖
```

### 3.2 部署 aiGenerate 云函数
重复相同操作：
1. 右键 `cloudfunctions/aiGenerate` 文件夹
2. 选择 **"创建并部署：云端安装依赖"**
3. 等待部署完成

### 3.3 部署 userInfo 云函数
1. 右键 `cloudfunctions/userInfo` 文件夹
2. 选择 **"创建并部署：云端安装依赖"**
3. 等待部署完成

### 3.4 部署 workManage 云函数
1. 右键 `cloudfunctions/workManage` 文件夹
2. 选择 **"创建并部署：云端安装依赖"**
3. 等待部署完成

## ✅ 第四步：验证部署结果

### 4.1 查看部署状态
1. 在微信开发者工具中，点击 **"云开发"** 按钮
2. 进入云开发控制台
3. 点击左侧 **"云函数"**
4. 确认所有4个函数都显示为 **"已部署"** 状态：
   ```
   ✅ login        - 已部署
   ✅ aiGenerate   - 已部署  
   ✅ userInfo     - 已部署
   ✅ workManage   - 已部署
   ```

### 4.2 测试云函数
在云函数页面，点击任意函数进入详情：
1. 点击 **"测试"** 标签
2. 输入测试参数（如登录函数）：
   ```json
   {
     "action": "guestLogin"
   }
   ```
3. 点击 **"测试"** 按钮
4. 查看返回结果，确认函数正常运行

## 🗄️ 第五步：配置数据库

### 5.1 创建数据库集合
在云开发控制台：
1. 点击左侧 **"数据库"**
2. 点击 **"新建集合"**
3. 依次创建以下集合：
   - `users` - 用户信息
   - `works` - 作品数据
   - `creditLogs` - 积分记录

### 5.2 设置集合权限
对每个集合设置权限：
1. 点击集合名称进入详情
2. 点击 **"权限设置"**
3. 选择 **"仅创建者可写，所有人可读"**

## 🔑 第六步：配置环境变量

### 6.1 设置API密钥
1. 在云开发控制台，点击 **"环境"** → **"环境变量"**
2. 点击 **"新增变量"**
3. **变量名**：`ZHIPU_API_KEY`
4. **变量值**：您的智谱AI API密钥
5. 点击 **"确定"**

## 🚀 第七步：测试小程序

### 7.1 编译运行
1. 在微信开发者工具中点击 **"编译"**
2. 查看编译器控制台，确保无错误
3. 在模拟器中测试基本功能

### 7.2 功能测试清单
- [ ] 小程序启动正常
- [ ] 用户登录功能
- [ ] AI图片生成功能
- [ ] 作品保存功能
- [ ] 历史记录查看

## ⚠️ 常见问题与解决

### Q1: 找不到"创建并部署"选项
**原因**：未正确开通云开发或环境未配置
**解决**：
1. 确认已开通云开发
2. 检查 `project.config.json` 中的 `cloudfunctionRoot` 配置
3. 重启微信开发者工具

### Q2: 部署失败 "网络错误"
**解决**：
1. 检查网络连接
2. 切换网络环境重试
3. 清除工具缓存：设置 → 通用设置 → 清除缓存

### Q3: 云函数调用失败
**检查项**：
1. 环境ID是否正确配置
2. 云函数是否部署成功
3. 网络权限是否开启

### Q4: 依赖安装失败
**解决**：
1. 选择"创建并部署：云端安装依赖"（让云端安装）
2. 确保云函数目录下有正确的 `package.json`
3. 检查依赖包是否有安全漏洞

## 📱 界面截图说明

### 右键菜单位置示意：
```
文件管理器
└── cloudfunctions/
    ├── login/          ← 右键这里
    │   ├── index.js
    │   └── package.json
    ├── aiGenerate/     ← 右键这里
    ├── userInfo/       ← 右键这里
    └── workManage/     ← 右键这里
```

### 部署进度提示：
```
工具底部状态栏会显示：
"正在上传云函数 login..."
"上传成功"
```

## 🎯 关键提示

1. **必须选择"云端安装依赖"**：因为云函数运行环境与本地不同
2. **按顺序部署**：建议按 login → userInfo → aiGenerate → workManage 顺序
3. **耐心等待**：首次部署需要安装依赖，可能需要1-3分钟
4. **检查日志**：如有问题，查看云开发控制台的函数日志

---

**完成以上步骤后，您的云函数就部署成功了！** 🎉

下一步可以开始测试小程序的完整功能。 