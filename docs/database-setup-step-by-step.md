# 数据库集合创建详细指南

## 🚨 问题现象

登录时出现错误：
```
collection.get:fail -502005 database collection not exists
[ResourceNotFound] Db or Table not exist
```

**原因**：云函数已部署成功，但数据库集合还未创建。

## 🗄️ 解决方案：创建数据库集合

### 第一步：进入云开发控制台

#### 方法一：通过微信开发者工具
1. 在微信开发者工具中，点击工具栏的 **"云开发"** 按钮
2. 进入云开发控制台

#### 方法二：直接访问控制台
1. 访问：https://console.cloud.tencent.com/tcb
2. 选择您的环境

### 第二步：创建数据库集合

#### 2.1 进入数据库页面
1. 在云开发控制台左侧菜单中，点击 **"数据库"**
2. 确认选择的是正确的环境（如：ai-image-prod）

#### 2.2 创建 users 集合
1. 点击 **"新建集合"** 按钮
2. **集合名称**：`users`
3. **权限设置**：选择 **"仅创建者可写，所有人可读"**
4. 点击 **"确定"**

#### 2.3 创建 works 集合
1. 再次点击 **"新建集合"**
2. **集合名称**：`works`
3. **权限设置**：选择 **"仅创建者可写，所有人可读"**
4. 点击 **"确定"**

#### 2.4 创建 creditLogs 集合
1. 再次点击 **"新建集合"**
2. **集合名称**：`creditLogs`
3. **权限设置**：选择 **"仅创建者可写，所有人可读"**
4. 点击 **"确定"**

### 第三步：验证集合创建

创建完成后，数据库页面应该显示以下3个集合：
```
✅ users        - 0 条记录
✅ works        - 0 条记录  
✅ creditLogs   - 0 条记录
```

### 第四步：配置集合权限（重要）

#### 4.1 配置 users 集合权限
1. 点击 `users` 集合名称进入详情
2. 点击 **"权限设置"** 标签
3. 选择 **"自定义安全规则"**
4. 输入以下规则：
   ```javascript
   {
     "read": true,
     "write": "doc._openid == auth.openid"
   }
   ```
5. 点击 **"保存"**

#### 4.2 配置 works 集合权限
1. 点击 `works` 集合名称进入详情
2. 点击 **"权限设置"** 标签
3. 选择 **"自定义安全规则"**
4. 输入以下规则：
   ```javascript
   {
     "read": true,
     "write": "doc.userId == auth.openid"
   }
   ```
5. 点击 **"保存"**

#### 4.3 配置 creditLogs 集合权限
1. 点击 `creditLogs` 集合名称进入详情
2. 点击 **"权限设置"** 标签
3. 选择 **"自定义安全规则"**
4. 输入以下规则：
   ```javascript
   {
     "read": "doc.userId == auth.openid",
     "write": "doc.userId == auth.openid"
   }
   ```
5. 点击 **"保存"**

### 第五步：创建数据库索引（优化性能）

#### 5.1 为 works 集合创建索引
1. 进入 `works` 集合详情
2. 点击 **"索引管理"** 标签
3. 点击 **"新增索引"**
4. 配置索引：
   ```json
   {
     "userId": 1,
     "createdAt": -1
   }
   ```
5. **索引名称**：`user_time_index`
6. 点击 **"保存"**

#### 5.2 为 users 集合创建索引
1. 进入 `users` 集合详情
2. 点击 **"索引管理"** 标签
3. 点击 **"新增索引"**
4. 配置索引：
   ```json
   {
     "_openid": 1
   }
   ```
5. **索引名称**：`openid_index`
6. 点击 **"保存"**

### 第六步：测试数据库连接

#### 6.1 手动添加测试数据
1. 进入 `users` 集合
2. 点击 **"添加记录"**
3. 输入测试数据：
   ```json
   {
     "_openid": "test_user",
     "nickname": "测试用户",
     "avatar": "",
     "credits": 100,
     "createdAt": "2025-06-24T08:00:00.000Z",
     "updatedAt": "2025-06-24T08:00:00.000Z"
   }
   ```
4. 点击 **"确定"**

#### 6.2 验证记录创建
确认 `users` 集合显示 "1 条记录"

## 🚀 第七步：重新测试小程序

### 7.1 重新编译小程序
1. 回到微信开发者工具
2. 点击 **"编译"** 按钮
3. 等待编译完成

### 7.2 测试登录功能
1. 在模拟器中点击登录按钮
2. 尝试游客登录
3. 确认不再出现数据库错误

## 📱 界面操作截图说明

### 数据库创建界面：
```
云开发控制台
└── 数据库
    ├── [新建集合] 按钮      ← 点击这里
    └── 集合列表
        ├── users           ← 创建后显示
        ├── works           ← 创建后显示
        └── creditLogs      ← 创建后显示
```

### 权限设置界面：
```
集合详情页
├── 记录管理
├── 权限设置    ← 点击这里
├── 索引管理
└── 统计分析
```

## ⚠️ 常见问题解决

### Q1: 找不到"数据库"菜单
**解决**：
- 确保已开通云开发
- 确保选择了正确的环境
- 刷新页面重试

### Q2: 权限设置失败
**解决**：
- 检查JSON语法是否正确
- 确保使用双引号，不是单引号
- 重新输入安全规则

### Q3: 索引创建失败
**解决**：
- 确保字段名正确
- 检查JSON格式
- 等待集合完全创建后再添加索引

### Q4: 仍然提示集合不存在
**解决**：
- 确认环境ID配置正确
- 重新部署云函数
- 清除小程序缓存重新编译

## 🎯 成功验证标准

完成所有步骤后，您应该看到：
- ✅ 数据库中有3个集合：users、works、creditLogs
- ✅ 每个集合权限设置正确
- ✅ 必要的索引已创建
- ✅ 小程序登录功能正常
- ✅ 不再出现数据库错误

## 📞 技术支持

如果按照步骤操作后仍有问题：
1. 检查云开发环境状态
2. 确认网络连接正常
3. 查看云函数调用日志
4. 参考腾讯云文档：https://cloud.tencent.com/document/product/876

---

**预计完成时间：10-15分钟** 🚀

完成后，您的AI文字生成图片小程序就可以正常使用了！ 