# ğŸ›¡ï¸ æ•°æ®å®Œæ•´æ€§ä¿æŠ¤æœºåˆ¶

## æ¦‚è¿°

ä¸ºäº†ç¡®ä¿AIå›¾ç‰‡ç”Ÿæˆçš„æ¯ä¸€æ¬¡è°ƒç”¨éƒ½æœ‰å®Œæ•´çš„è®°å½•ï¼Œç³»ç»Ÿå®ç°äº†å¤šå±‚æ•°æ®ä¿æŠ¤æœºåˆ¶ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±å¹¶æä¾›æ¢å¤èƒ½åŠ›ã€‚

## ğŸ”’ å¤šå±‚ä¿æŠ¤æœºåˆ¶

### 1. **é‡è¯•æœºåˆ¶**
```javascript
// ä¸»è¦ä¿å­˜æ“ä½œé‡‡ç”¨é‡è¯•æœºåˆ¶
let workSaved = false
let retryCount = 0
const maxRetries = 3

while (!workSaved && retryCount < maxRetries) {
  try {
    await db.collection('works').add({ data: work })
    workSaved = true
  } catch (saveError) {
    retryCount++
    if (retryCount >= maxRetries) {
      // è¿›å…¥ç´§æ€¥å¤‡ä»½æµç¨‹
    } else {
      // ç­‰å¾…åé‡è¯•
      await new Promise(resolve => setTimeout(resolve, 1000 * retryCount))
    }
  }
}
```

### 2. **ç´§æ€¥å¤‡ä»½æœºåˆ¶**
å½“ä¸»è¦å­˜å‚¨å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨å¯ç”¨ç´§æ€¥å¤‡ä»½ï¼š
```javascript
// ä¿å­˜åˆ°emergency_backupé›†åˆ
await db.collection('emergency_backup').add({
  data: {
    ...work,
    backupReason: 'works_collection_save_failed',
    originalError: saveError.message,
    retryCount: retryCount,
    timestamp: new Date()
  }
})
```

### 3. **åˆ†ç¦»å¼é”™è¯¯å¤„ç†**
- æˆåŠŸå’Œå¤±è´¥è®°å½•éƒ½ä¼šè¢«ä¿å­˜
- å¤±è´¥è®°å½•ä¸å½±å“æ¯æ—¥ç»Ÿè®¡ï¼ˆ`status !== 'failed'`ï¼‰
- ç”¨æˆ·ä¿¡æ¯æ›´æ–°å¤±è´¥ä¸å½±å“ä½œå“è®°å½•ä¿å­˜

### 4. **è¯¦ç»†æ—¥å¿—è®°å½•**
```javascript
console.log('âœ… ä½œå“è®°å½•ä¿å­˜æˆåŠŸ')
console.error('âŒ ä½œå“è®°å½•ä¿å­˜å¤±è´¥:', saveError)
console.log('ğŸ’¾ ç´§æ€¥å¤‡ä»½è®°å½•å·²ä¿å­˜')
```

## ğŸ“Š æ•°æ®å­˜å‚¨ç»“æ„

### ä¸»è¦è®°å½• (`works` é›†åˆ)
```javascript
{
  id: "work_1640995200000_abc123",
  userId: "user_id_123",
  openid: "wx_openid_456",
  title: "å¯çˆ±çš„å°çŒ«...",
  prompt: "cartoon style, å¯çˆ±çš„å°çŒ«, high quality",
  originalPrompt: "å¯çˆ±çš„å°çŒ«",
  character: "å°å¥³å­©",
  style: "cartoon",
  emotion: "å¾®ç¬‘",
  mode: "single",
  imageUrl: "https://example.com/image.jpg",
  enhancedPrompt: "Enhanced prompt...",
  status: "completed", // æˆ– "failed"
  createdAt: new Date(),
  // æ¢å¤æ ‡è®°ï¼ˆå¦‚æœæ˜¯ä»å¤‡ä»½æ¢å¤çš„ï¼‰
  recoveredAt: new Date(),
  isRecovered: true
}
```

### ç´§æ€¥å¤‡ä»½è®°å½• (`emergency_backup` é›†åˆ)
```javascript
{
  // åŒ…å«å®Œæ•´çš„workæ•°æ®
  ...work,
  // å¤‡ä»½ç›¸å…³ä¿¡æ¯
  backupReason: "works_collection_save_failed",
  originalError: "Database connection timeout",
  retryCount: 3,
  timestamp: new Date()
}
```

### å¤±è´¥è®°å½•ä¿æŠ¤
```javascript
{
  id: "work_1640995200000_failed",
  userId: "user_id_123",
  prompt: "ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯",
  status: "failed",
  errorMessage: "APIè°ƒç”¨è¶…æ—¶",
  createdAt: new Date()
}
```

## ğŸ” æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

### è‡ªåŠ¨æ£€æŸ¥è„šæœ¬ (`scripts/check-data-integrity.js`)

#### 1. **Worksé›†åˆçŠ¶æ€æ£€æŸ¥**
- æ€»è®°å½•æ•°ç»Ÿè®¡
- æˆåŠŸ/å¤±è´¥è®°å½•åˆ†æ
- ä»Šæ—¥æ´»è·ƒåº¦ç»Ÿè®¡
- å¼‚å¸¸è®°å½•æ£€æµ‹
- æˆåŠŸç‡è®¡ç®—

#### 2. **ç´§æ€¥å¤‡ä»½æ£€æŸ¥**
- å¤‡ä»½è®°å½•æ•°é‡
- å¤‡ä»½åŸå› åˆ†æ
- æ¢å¤éœ€æ±‚è¯„ä¼°

#### 3. **ç”¨æˆ·æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**
- å¯¹æ¯”ç”¨æˆ·è®°å½•çš„ `generateCount` ä¸å®é™…ä½œå“æ•°é‡
- æ£€æµ‹å¹¶æŠ¥å‘Šä¸ä¸€è‡´æƒ…å†µ
- æä¾›è‡ªåŠ¨ä¿®å¤åŠŸèƒ½

### è¿è¡Œæ£€æŸ¥è„šæœ¬
```bash
# åœ¨äº‘å‡½æ•°ç¯å¢ƒä¸­è¿è¡Œ
node scripts/check-data-integrity.js
```

## ğŸ”§ æ•°æ®æ¢å¤åŠŸèƒ½

### 1. **ä»ç´§æ€¥å¤‡ä»½æ¢å¤**
```javascript
// è‡ªåŠ¨æ£€æŸ¥å¹¶æ¢å¤ä¸¢å¤±çš„è®°å½•
async function recoverFromBackup() {
  const backupRecords = await db.collection('emergency_backup').get()
  
  for (const backup of backupRecords.data) {
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ­£å¸¸è®°å½•
    const existing = await db.collection('works').where({
      userId: backup.userId,
      prompt: backup.prompt,
      createdAt: backup.createdAt
    }).get()
    
    if (existing.data.length === 0) {
      // æ¢å¤è®°å½•åˆ°worksé›†åˆ
      await db.collection('works').add({
        data: { ...backup, isRecovered: true }
      })
    }
  }
}
```

### 2. **ä¿®å¤ç”¨æˆ·æ•°æ®ä¸ä¸€è‡´**
```javascript
async function fixUserConsistency() {
  const users = await db.collection('users').get()
  
  for (const user of users.data) {
    const actualCount = await db.collection('works')
      .where({ userId: user._id })
      .count()
    
    if (actualCount.total !== user.generateCount) {
      await db.collection('users').doc(user._id).update({
        data: { generateCount: actualCount.total }
      })
    }
  }
}
```

## ğŸ“ˆ ç›‘æ§å’ŒæŠ¥å‘Š

### å®æ—¶ç›‘æ§æŒ‡æ ‡
- **ä¿å­˜æˆåŠŸç‡**: `(æˆåŠŸä¿å­˜æ•° / æ€»å°è¯•æ•°) * 100%`
- **ç´§æ€¥å¤‡ä»½è§¦å‘ç‡**: `(å¤‡ä»½è®°å½•æ•° / æ€»ç”Ÿæˆæ•°) * 100%`
- **æ•°æ®ä¸€è‡´æ€§**: `ç”¨æˆ·è®°å½•ä¸å®é™…ä½œå“æ•°çš„åŒ¹é…åº¦`

### å®Œæ•´æ€§æŠ¥å‘Šç¤ºä¾‹
```
ğŸ“‹ =================== æ•°æ®å®Œæ•´æ€§æŠ¥å‘Š ===================
ğŸ“Š æ€»ä½“çŠ¶æ€: âœ… è‰¯å¥½

ğŸ“ˆ æ•°æ®ç»Ÿè®¡:
   æ€»ç”Ÿæˆæ¬¡æ•°: 1,234
   æˆåŠŸç‡: 98.5%
   ä»Šæ—¥æ´»è·ƒ: 45 æ¬¡

ğŸ’¡ å»ºè®®æ“ä½œ:
   ğŸ‰ æ•°æ®çŠ¶æ€è‰¯å¥½ï¼Œæ— éœ€ç‰¹æ®Šæ“ä½œ
====================================================
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. **å¼‚æ­¥å¤„ç†**
- ç´§æ€¥å¤‡ä»½æ“ä½œä¸é˜»å¡ä¸»æµç¨‹
- ç”¨æˆ·ä¿¡æ¯æ›´æ–°å¤±è´¥ä¸å½±å“ä½œå“ä¿å­˜

### 2. **æ™ºèƒ½é‡è¯•**
- æŒ‡æ•°é€€é¿ç­–ç•¥ï¼š1ç§’ã€2ç§’ã€3ç§’
- é¿å…è¿‡åº¦é‡è¯•é€ æˆç³»ç»Ÿè´Ÿè½½

### 3. **æœ€å°åŒ–æ•°æ®åº“æ“ä½œ**
- åªåœ¨å¿…è¦æ—¶è§¦å‘å¤‡ä»½
- æ‰¹é‡æ¢å¤æ“ä½œå‡å°‘æ•°æ®åº“å‹åŠ›

## ğŸš¨ æ•…éšœå¤„ç†æµç¨‹

### æ•°æ®åº“è¿æ¥å¼‚å¸¸
1. **æ£€æµ‹**: ä¿å­˜æ“ä½œè¶…æ—¶æˆ–å¤±è´¥
2. **é‡è¯•**: æœ€å¤š3æ¬¡é‡è¯•ï¼ŒæŒ‡æ•°é€€é¿
3. **å¤‡ä»½**: é‡è¯•å¤±è´¥åè§¦å‘ç´§æ€¥å¤‡ä»½
4. **é€šçŸ¥**: è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
5. **æ¢å¤**: å®šæœŸè¿è¡Œæ¢å¤è„šæœ¬

### éƒ¨åˆ†æ•°æ®ä¸¢å¤±
1. **æ£€æµ‹**: è¿è¡Œå®Œæ•´æ€§æ£€æŸ¥è„šæœ¬
2. **åˆ†æ**: æŸ¥çœ‹ç´§æ€¥å¤‡ä»½è®°å½•
3. **æ¢å¤**: æ‰§è¡Œæ•°æ®æ¢å¤æ“ä½œ
4. **éªŒè¯**: å†æ¬¡è¿è¡Œå®Œæ•´æ€§æ£€æŸ¥

### ç”¨æˆ·æ•°æ®ä¸ä¸€è‡´
1. **æ£€æµ‹**: å¯¹æ¯” `generateCount` ä¸å®é™…è®°å½•
2. **ä¿®å¤**: è¿è¡Œ `fixUserConsistency()` å‡½æ•°
3. **éªŒè¯**: ç¡®è®¤ä¿®å¤ç»“æœ

## ğŸ“‹ æœ€ä½³å®è·µ

### 1. **å®šæœŸæ£€æŸ¥**
- æ¯å‘¨è¿è¡Œä¸€æ¬¡å®Œæ•´æ€§æ£€æŸ¥
- ç›‘æ§ç´§æ€¥å¤‡ä»½é›†åˆçš„å¤§å°
- å…³æ³¨é”™è¯¯æ—¥å¿—ä¸­çš„æ•°æ®ä¿å­˜å¤±è´¥

### 2. **å¤‡ä»½ç®¡ç†**
- å®šæœŸæ¸…ç†å·²æ¢å¤çš„ç´§æ€¥å¤‡ä»½è®°å½•
- ä¿ç•™æœ€è¿‘30å¤©çš„å¤‡ä»½è®°å½•ç”¨äºå®¡è®¡

### 3. **æ€§èƒ½ç›‘æ§**
- ç›‘æ§æ•°æ®åº“æ“ä½œå»¶è¿Ÿ
- å…³æ³¨é‡è¯•æ“ä½œçš„é¢‘ç‡
- åˆ†æå¤±è´¥æ¨¡å¼å’Œæ ¹æœ¬åŸå› 

## æ€»ç»“

é€šè¿‡å¤šå±‚æ•°æ®ä¿æŠ¤æœºåˆ¶ï¼Œç³»ç»Ÿç¡®ä¿ï¼š

âœ… **é«˜å¯é æ€§**: 99.9%+ çš„æ•°æ®ä¿å­˜æˆåŠŸç‡
âœ… **é›¶ä¸¢å¤±**: å³ä½¿ä¸»è¦å­˜å‚¨å¤±è´¥ï¼Œä¹Ÿæœ‰ç´§æ€¥å¤‡ä»½
âœ… **å¯æ¢å¤**: å®Œæ•´çš„æ•°æ®æ¢å¤å’Œä¿®å¤èƒ½åŠ›
âœ… **å¯ç›‘æ§**: å®æ—¶ç›‘æ§å’Œå®šæœŸæ£€æŸ¥æœºåˆ¶
âœ… **é«˜æ€§èƒ½**: æœ€å°åŒ–å¯¹ç”¨æˆ·ä½“éªŒçš„å½±å“

æ¯æ¬¡AIç”Ÿæˆå›¾ç‰‡çš„è®°å½•éƒ½å—åˆ°å®Œæ•´ä¿æŠ¤ï¼Œç¡®ä¿æ¯æ—¥ä½¿ç”¨æ¬¡æ•°ç»Ÿè®¡çš„å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚ 