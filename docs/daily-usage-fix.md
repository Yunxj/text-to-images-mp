# æ¯æ—¥ä½¿ç”¨é‡è·å–é”™è¯¯ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
è·å–æ¯æ—¥ä½¿ç”¨é‡å¤±è´¥: Error: æœªçŸ¥çš„æ“ä½œç±»å‹
    at Function.success (cloudApi.js:19)
```

### é”™è¯¯åŸå› 
é¡µé¢åŠ è½½æ—¶ç«‹å³è°ƒç”¨ `getDailyUsage()`ï¼Œä½†æ­¤æ—¶ç”¨æˆ·å¯èƒ½è¿˜æ²¡æœ‰å®Œæˆç™»å½•åˆå§‹åŒ–ï¼Œå¯¼è‡´ï¼š

1. **æ—¶åºé—®é¢˜**ï¼š`onLoad()` ä¸­åŒæ—¶è°ƒç”¨äº† `initUser()` å’Œ `loadDailyUsage()`ï¼Œä½†ç”¨æˆ·åˆå§‹åŒ–æ˜¯å¼‚æ­¥çš„
2. **ç”¨æˆ·çŠ¶æ€ä¸æ˜**ï¼šäº‘å‡½æ•° `getDailyUsage` éœ€è¦ç”¨æˆ·ä¿¡æ¯ï¼Œä½†æ­¤æ—¶å¯èƒ½ç”¨æˆ·è¿˜æœªç™»å½•
3. **é”™è¯¯å¤„ç†ä¸è¶³**ï¼šæ²¡æœ‰å¯¹ç”¨æˆ·æœªç™»å½•çš„æƒ…å†µè¿›è¡Œå¤„ç†

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. ä¼˜åŒ–åˆå§‹åŒ–æ—¶åº

**ä¿®å¤å‰ï¼š**
```javascript
onLoad() {
  this.initCharacters()
  this.initUser()           // å¼‚æ­¥åˆå§‹åŒ–ç”¨æˆ·
  this.loadDailyUsage()     // ç«‹å³è°ƒç”¨ï¼Œå¯èƒ½å¤±è´¥
}
```

**ä¿®å¤åï¼š**
```javascript
onLoad() {
  this.initCharacters()
  this.initUserAndData()    // ç»Ÿä¸€çš„åˆå§‹åŒ–æ–¹æ³•
}

async initUserAndData() {
  if (app.globalData.userInfo) {
    // ç”¨æˆ·å·²ç™»å½•ï¼Œåˆå§‹åŒ–æ•°æ®
    this.setData({ remainingCount: ... })
    await this.loadDailyUsage()  // ç¡®ä¿ç”¨æˆ·ç™»å½•åå†è°ƒç”¨
  } else {
    // ç­‰å¾…ç”¨æˆ·ç™»å½•å®Œæˆ
    setTimeout(() => this.initUserAndData(), 1000)
  }
}
```

### 2. å¢å¼ºé”™è¯¯å¤„ç†

**ä¿®å¤å‰ï¼š**
```javascript
async loadDailyUsage() {
  try {
    const result = await aiAPI.getDailyUsage()
    // å¤„ç†ç»“æœ...
  } catch (error) {
    console.error('è·å–æ¯æ—¥ä½¿ç”¨é‡å¤±è´¥:', error)
    // æ²¡æœ‰è®¾ç½®é»˜è®¤æ•°æ®ï¼Œé¡µé¢å¯èƒ½æŠ¥é”™
  }
}
```

**ä¿®å¤åï¼š**
```javascript
async loadDailyUsage() {
  try {
    // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
    const app = getApp()
    if (!app.globalData.userInfo) {
      console.log('ç”¨æˆ·æœªç™»å½•ï¼Œè·³è¿‡åŠ è½½æ¯æ—¥ä½¿ç”¨é‡')
      this.setData({
        dailyUsage: { // è®¾ç½®é»˜è®¤æ¸¸å®¢æ•°æ®
          todayUsed: 0,
          dailyLimit: 10,
          remaining: 10,
          userType: 'guest'
        }
      })
      return
    }

    const result = await aiAPI.getDailyUsage()
    // å¤„ç†ç»“æœ...
  } catch (error) {
    console.error('è·å–æ¯æ—¥ä½¿ç”¨é‡å¤±è´¥:', error)
    
    // è®¾ç½®é»˜è®¤æ•°æ®é¿å…é¡µé¢æŠ¥é”™
    this.setData({
      dailyUsage: {
        todayUsed: 0,
        dailyLimit: 10,
        remaining: 10,
        userType: 'guest',
        error: true
      }
    })
  }
}
```

### 3. æ•°æ®å®‰å…¨æ£€æŸ¥

**ä¿®å¤å‰ï¼š**
```javascript
// æ£€æŸ¥æ¯æ—¥é™åˆ¶
if (dailyUsage.remaining <= 0) {  // å¯èƒ½æŠ¥é”™ï¼ŒdailyUsage å¯èƒ½ä¸º undefined
  // æ˜¾ç¤ºé™åˆ¶æç¤º...
}
```

**ä¿®å¤åï¼š**
```javascript
// æ£€æŸ¥æ¯æ—¥é™åˆ¶
if (dailyUsage && dailyUsage.remaining <= 0) {  // å®‰å…¨æ£€æŸ¥
  wx.showModal({
    title: 'ä»Šæ—¥ç”Ÿæˆæ¬¡æ•°å·²ç”¨å®Œ',
    content: `æ‚¨ä»Šæ—¥å·²ä½¿ç”¨ ${dailyUsage.todayUsed}/${dailyUsage.dailyLimit} æ¬¡...`,
    // ...
  })
}
```

## ğŸ“‹ ä¿®å¤æ¸…å•

### ä¿®å¤çš„æ–‡ä»¶ï¼š
- **`pages/index/index.js`** - é¦–é¡µåˆå§‹åŒ–é€»è¾‘

### ä¸»è¦æ”¹åŠ¨ï¼š
1. âœ… **åˆå¹¶åˆå§‹åŒ–æ–¹æ³•**ï¼š`initUserAndData()` ç¡®ä¿ç”¨æˆ·ç™»å½•åå†åŠ è½½æ•°æ®
2. âœ… **å¢å¼ºé”™è¯¯å¤„ç†**ï¼šæœªç™»å½•æ—¶è®¾ç½®é»˜è®¤æ•°æ®ï¼Œé¿å…é¡µé¢æŠ¥é”™
3. âœ… **å®‰å…¨æ•°æ®æ£€æŸ¥**ï¼šæ‰€æœ‰ä½¿ç”¨ `dailyUsage` çš„åœ°æ–¹éƒ½å¢åŠ äº†ç©ºå€¼æ£€æŸ¥
4. âœ… **æ›´å¥½çš„æ—¥å¿—è®°å½•**ï¼šå¢åŠ è°ƒè¯•ä¿¡æ¯ï¼Œä¾¿äºé—®é¢˜å®šä½

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤åçš„ç”¨æˆ·ä½“éªŒï¼š
- âœ… **é¡µé¢åŠ è½½æ— é”™è¯¯**ï¼šä¸å†å‡ºç°"æœªçŸ¥çš„æ“ä½œç±»å‹"é”™è¯¯
- âœ… **æ¸¸å®¢å‹å¥½**ï¼šæœªç™»å½•ç”¨æˆ·ä¹Ÿèƒ½çœ‹åˆ°é»˜è®¤çš„ä½¿ç”¨é‡ä¿¡æ¯
- âœ… **æ¸è¿›å¼åŠ è½½**ï¼šç”¨æˆ·ç™»å½•åè‡ªåŠ¨åŠ è½½çœŸå®æ•°æ®
- âœ… **é”™è¯¯å®¹é”™**ï¼šç½‘ç»œé”™è¯¯æ—¶æ˜¾ç¤ºé»˜è®¤æ•°æ®ï¼Œä¸å½±å“é¡µé¢ä½¿ç”¨

### æ•°æ®æµç¨‹ï¼š
1. **é¡µé¢åŠ è½½** â†’ åˆå§‹åŒ–è§’è‰²æ•°æ®
2. **æ£€æŸ¥ç”¨æˆ·ç™»å½•** â†’ å¦‚æœæœªç™»å½•ï¼Œè®¾ç½®é»˜è®¤æ•°æ®å¹¶ç­‰å¾…
3. **ç”¨æˆ·ç™»å½•å®Œæˆ** â†’ åŠ è½½çœŸå®çš„æ¯æ—¥ä½¿ç”¨é‡æ•°æ®
4. **é”™è¯¯æƒ…å†µ** â†’ æ˜¾ç¤ºé»˜è®¤æ•°æ®ï¼Œè®°å½•é”™è¯¯æ—¥å¿—

## ğŸ” é—®é¢˜æ ¹å› åˆ†æ

### åŸå§‹é”™è¯¯çš„æŠ€æœ¯åŸå› ï¼š
1. **å¼‚æ­¥ç«æ€æ¡ä»¶**ï¼š`initUser()` å’Œ `loadDailyUsage()` å¹¶å‘æ‰§è¡Œ
2. **äº‘å‡½æ•°ä¾èµ–**ï¼š`getDailyUsage` ä¾èµ–ç”¨æˆ·èº«ä»½ï¼Œä½†è°ƒç”¨æ—¶ç”¨æˆ·å¯èƒ½æœªåˆå§‹åŒ–
3. **é”™è¯¯ä¼ æ’­**ï¼šé”™è¯¯å¤„ç†ä¸å……åˆ†ï¼Œå¯¼è‡´é¡µé¢åŠŸèƒ½å—å½±å“

### è®¾è®¡åŸåˆ™ï¼š
- **å®¹é”™æ€§**ï¼šä»»ä½•æ—¶å€™éƒ½åº”è¯¥æœ‰åˆç†çš„é»˜è®¤æ•°æ®
- **æ¸è¿›å¼**ï¼šåŠŸèƒ½åº”è¯¥èƒ½åœ¨éƒ¨åˆ†æ•°æ®ç¼ºå¤±æ—¶æ­£å¸¸å·¥ä½œ
- **ç”¨æˆ·å‹å¥½**ï¼šé”™è¯¯ä¸åº”è¯¥å½±å“æ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯ï¼š
1. **æœªç™»å½•ç”¨æˆ·**ï¼šç›´æ¥æ‰“å¼€é¡µé¢ï¼Œåº”æ˜¾ç¤ºé»˜è®¤ä½¿ç”¨é‡
2. **å·²ç™»å½•ç”¨æˆ·**ï¼šåº”æ­£ç¡®æ˜¾ç¤ºçœŸå®ä½¿ç”¨é‡æ•°æ®
3. **ç½‘ç»œé”™è¯¯**ï¼šæ¨¡æ‹Ÿç½‘ç»œé—®é¢˜ï¼Œåº”æ˜¾ç¤ºé»˜è®¤æ•°æ®
4. **äº‘å‡½æ•°é”™è¯¯**ï¼šæ¨¡æ‹Ÿäº‘å‡½æ•°é—®é¢˜ï¼Œåº”æœ‰é”™è¯¯æç¤º

### éªŒè¯ç‚¹ï¼š
- é¡µé¢åŠ è½½æ— æ§åˆ¶å°é”™è¯¯
- ä½¿ç”¨é‡æ•°æ®æ­£ç¡®æ˜¾ç¤º
- ç”ŸæˆåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- é”™è¯¯æƒ…å†µä¸‹çš„ç”¨æˆ·ä½“éªŒ

ç°åœ¨æ¯æ—¥ä½¿ç”¨é‡åŠŸèƒ½åº”è¯¥ç¨³å®šå·¥ä½œäº†ï¼ğŸ‰ 